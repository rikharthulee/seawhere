name: Supabase DB Backup (IPv4 forced & trimmed host)

on:
  workflow_dispatch: {}
  # schedule:
  #   - cron: '0 3 * * *'

jobs:
  dump:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client dnsutils netcat-traditional jq curl

      - name: Normalize host secret (trim whitespace)
        id: norm
        run: |
          RAW_HOST="${{ secrets.SUPABASE_DB_HOST }}"
          # Trim spaces, tabs, CR, LF
          HOST=$(printf "%s" "$RAW_HOST" | tr -d ' \t\r\n')
          if [ -z "$HOST" ]; then
            echo "Host secret is empty after trimming"; exit 1
          fi
          echo "HOST=$HOST" >> "$GITHUB_ENV"
          echo "Using host: $HOST"

      - name: Resolve IPv4 for Supabase host (multiple resolvers)
        id: dns
        env:
          HOST: ${{ env.HOST }}
        run: |
          set -euo pipefail
          try_resolve() { dig +short A "$1" @"$2" | head -n1 || true; }
          IP=$(getent ahostsv4 "$HOST" | awk '{print $1; exit}' || true)
          [ -z "$IP" ] && IP=$(dig +short A "$HOST" | head -n1 || true)
          [ -z "$IP" ] && IP=$(try_resolve "$HOST" 1.1.1.1)
          [ -z "$IP" ] && IP=$(try_resolve "$HOST" 8.8.8.8)
          # Last resort: DoH to Google
          if [ -z "$IP" ]; then
            IP=$(curl -s "https://dns.google/resolve?name=$HOST&type=A" \
              | jq -r '.Answer[]?.data' | head -n1 || true)
          fi
          if [ -z "$IP" ]; then
            echo "Failed to resolve IPv4 A record for $HOST"; exit 1
          fi
          echo "IPv4=$IP"
          echo "IPV4=$IP" >> "$GITHUB_ENV"

      - name: Sanity check connectivity (IPv4, port 5432)
        env:
          IPV4: ${{ env.IPV4 }}
        run: |
          set -euo pipefail
          nc -vz "$IPV4" 5432

      - name: Sanity check DB auth (list tables)
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
          IPV4: ${{ env.IPV4 }}
          HOST: ${{ env.HOST }}
          DB_USER: ${{ secrets.SUPABASE_DB_USER }}
          DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}
        run: |
          set -euo pipefail
          # hostaddr forces IPv4; host keeps TLS/SNI validation happy
          psql "hostaddr=$IPV4 host=$HOST port=5432 user=$DB_USER dbname=$DB_NAME sslmode=require" -c '\dt'

      - name: Dump database (schema + data), verify, compress
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
          IPV4: ${{ env.IPV4 }}
          HOST: ${{ env.HOST }}
          DB_USER: ${{ secrets.SUPABASE_DB_USER }}
          DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}
        run: |
          set -euo pipefail
          TS=$(date -u +'%Y%m%dT%H%M%SZ')
          RAW="japanman_backup_${TS}.sql"
          OUT="${RAW}.gz"
          echo "Dumping via IPv4 $IPV4 with SSL..."
          pg_dump \
            --hostaddr="$IPV4" \
            --host="$HOST" \
            --port=5432 \
            --username="$DB_USER" \
            --dbname="$DB_NAME" \
            --clean --if-exists \
            --no-owner \
            --format=plain \
            --verbose \
            --file="$RAW"
          test -s "$RAW" || (echo "Dump file is empty"; exit 1)
          gzip -9 "$RAW"
          echo "OUT=$OUT" >> $GITHUB_ENV
          ls -lh "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup
          path: ${{ env.OUT }}
          retention-days: 14
