name: Supabase DB Backup

on:
  workflow_dispatch: {}
  # schedule:
  #   - cron: '0 3 * * *'   # daily 03:00 UTC

jobs:
  dump:
    runs-on: ubuntu-latest
    steps:
      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Sanity check connection (lists tables & shows DB size)
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
        run: |
          set -euo pipefail
          psql "host=${{ secrets.SUPABASE_DB_HOST }} port=5432 user=${{ secrets.SUPABASE_DB_USER }} dbname=${{ secrets.SUPABASE_DB_NAME }}" -c '\dt' || (echo "Cannot list tables"; exit 1)
          psql "host=${{ secrets.SUPABASE_DB_HOST }} port=5432 user=${{ secrets.SUPABASE_DB_USER }} dbname=${{ secrets.SUPABASE_DB_NAME }}" -c "select now() as utc_now, current_database() as db, pg_size_pretty(pg_database_size(current_database())) as size;"

      - name: Dump database (schema + data)
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
        run: |
          set -euo pipefail
          TS=$(date -u +'%Y%m%dT%H%M%SZ')
          RAW="japanman_backup_${TS}.sql"
          OUT="japanman_backup_${TS}.sql.gz"

          echo "Running pg_dump -> $RAW"
          pg_dump \
            --host="${{ secrets.SUPABASE_DB_HOST }}" \
            --port=5432 \
            --username="${{ secrets.SUPABASE_DB_USER }}" \
            --dbname="${{ secrets.SUPABASE_DB_NAME }}" \
            --clean --if-exists \
            --no-owner \
            --format=plain \
            --verbose \
            --file="$RAW"

          echo "Verifying dump size..."
          test -s "$RAW" || (echo "Dump file is empty"; exit 1)

          echo "Compressing -> $OUT"
          gzip -9 "$RAW"
          echo "OUT=$OUT" >> $GITHUB_ENV
          ls -lh "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup
          path: ${{ env.OUT }}
          retention-days: 14
