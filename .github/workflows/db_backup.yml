name: Supabase DB Backup (session pooler via Docker PG17)

on:
  workflow_dispatch: {}
  # schedule:
  #   - cron: '0 3 * * *'  # optional daily run

jobs:
  dump:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.SUPABASE_SESSION_HOST }}   # e.g. your session pooler host
      PORT: ${{ secrets.SUPABASE_SESSION_PORT }}   # 5432
      DB_USER: ${{ secrets.SUPABASE_DB_USER }}     # postgres.<project_ref>
      DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}     # postgres
    steps:
      - name: Pull postgres:17 image
        run: docker pull postgres:17

      - name: Sanity check DB auth (psql inside container)
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          docker run --rm -e PGPASSWORD="$PGPASSWORD" postgres:17 psql \
            "host=${HOST} port=${PORT} user=${DB_USER} dbname=${DB_NAME} sslmode=require" \
            -c '\dt'

      - name: Dump schema+data (pg_dump 17 in container), verify, gzip
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          set -euo pipefail
          TS="$(date -u +'%Y%m%dT%H%M%SZ')"
          RAW="japanman_backup_${TS}.sql"

          docker run --rm -e PGPASSWORD="$PGPASSWORD" postgres:17 pg_dump \
            "host=${HOST} port=${PORT} user=${DB_USER} dbname=${DB_NAME} sslmode=require" \
            --clean --if-exists \
            --no-owner --no-privileges \
            --format=plain \
            --verbose \
            > "$RAW"

          test -s "$RAW"
          gzip -9 "$RAW"
          echo "OUT=${RAW}.gz" >> "$GITHUB_ENV"
          ls -lh "${RAW}.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup
          path: ${{ env.OUT }}
          retention-days: 14
