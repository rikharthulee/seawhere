name: Supabase DB Backup (Session pooler, PG17)

on:
  workflow_dispatch: {}        # run manually from Actions tab
  # schedule:                  # optional: daily at 03:00 UTC
  #   - cron: '0 3 * * *'

jobs:
  dump:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.SUPABASE_SESSION_HOST }}   # e.g. your session pooler host
      PORT: ${{ secrets.SUPABASE_SESSION_PORT }}   # e.g. 5432
      DB_USER: ${{ secrets.SUPABASE_DB_USER }}     # e.g. postgres.<project_ref>
      DB_NAME: ${{ secrets.SUPABASE_DB_NAME }}     # usually postgres
      PGSSLMODE: require                           # force TLS
    steps:
      - name: Install Postgres 17 client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17 netcat-traditional

      - name: Check TCP reachability (optional)
        run: nc -vz "$HOST" "$PORT"

      - name: Sanity check DB auth
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          psql "host=$HOST port=$PORT user=$DB_USER dbname=$DB_NAME sslmode=$PGSSLMODE" -c '\dt'

      - name: Dump schema+data, verify, gzip
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          set -euo pipefail
          TS=$(date -u +'%Y%m%dT%H%M%SZ')
          RAW="japanman_backup_${TS}.sql"
          OUT="${RAW}.gz"

          pg_dump "host=$HOST port=$PORT user=$DB_USER dbname=$DB_NAME sslmode=$PGSSLMODE" \
            --clean --if-exists \
            --no-owner --no-privileges \
            --format=plain \
            --verbose \
            --file="$RAW"

          test -s "$RAW" || (echo "Dump file is empty"; exit 1)
          gzip -9 "$RAW"
          echo "OUT=$OUT" >> "$GITHUB_ENV"
          ls -lh "$OUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup
          path: ${{ env.OUT }}
          retention-days: 14
