# ğŸ§­ JapanMan Itinerary Checker â€“ Overview

## Purpose

Warn or block itinerary days when included sights are closed or uncertain â€” **after** the user adds travel dates.  
In browse mode (no dates), show a light disclaimer only.

---

## ğŸ¯ Core Principles

- Keep logic **simple, reliable, and transparent**.
- Only check closures **after dates are known**.
- Use small, clear rules instead of deep automation.
- Treat closures as **warnings, not disasters** (unless a key sight is affected).

---

## ğŸ§± Data Model (per Sight)

| Field                      | Type  | Description                               |
| -------------------------- | ----- | ----------------------------------------- |
| `closed_days`              | array | e.g. `["MON"]` â€“ recurring weekly closure |
| `holiday_policy`           | enum  | `open` \| `closed` \| `unknown`           |
| `defer_closure_on_holiday` | enum  | `never` \| `next_weekday`                 |
| `notes_url`                | text  | official site link (optional)             |

### Optional flags

- `importance`: `"anchor"` or `"nice"` â€“ used inside excursions.
- `category` / `division`: for swap suggestions.

---

## ğŸ“… Central Holiday List

- Cached once per year from **Nager.Date API** or **Google Japan Holiday ICS**.
- Normalized to `{ date, name, type }`.
- Used globally â€“ sights reference it, not duplicate it.

---

## âš™ï¸ Checker Logic (simplified)

1. **Hard Exceptions**

   - e.g. maintenance, New Year closures â†’ immediate block.

2. **Holiday Check**

   - If `holiday_policy = closed` â†’ `CLOSED (holiday)`
   - If `holiday_policy = open` â†’ `OPEN (holiday)`
   - If `holiday_policy = unknown` â†’ `UNKNOWN (holiday â€” check manually)`

3. **Weekly Closure**

   - If `weekday âˆˆ closed_days` â†’ `CLOSED (recurring)`

4. **Deferred Closure**

   - If **yesterday was a holiday** and `defer_closure_on_holiday = next_weekday`  
     â†’ `CLOSED (deferred)` (unless today is also a holiday)

5. **Default**
   - Otherwise â†’ `OPEN (normal)`

---

## ğŸš¦ Result States

| State       | Meaning                    | Example UI           |
| ----------- | -------------------------- | -------------------- |
| âœ… OPEN     | Good to go                 | Green dot            |
| âš ï¸ UNKNOWN  | Likely open but unverified | Amber dot            |
| â›” CLOSED   | Confirmed closure          | Greyed out / tooltip |
| â„ï¸ DEFERRED | Closed day after holiday   | Greyed out / tooltip |

---

## ğŸ§© Excursion-Level Logic

1. Each excursion step tagged `importance = "anchor" | "nice"`.
2. If any **anchor** is closed â†’ block day (`â›”`).
3. If only **nice-to-haves** closed â†’ allow with warning (`âš ï¸`).
4. Suggest swaps for closed nice-to-haves:
   - Same `category`
   - Same `division`
   - Confirmed `OPEN` on that date

---

## ğŸ’¬ UX Copy Examples

- â€œClosed every Monday.â€
- â€œOpen on holidays; closed the following day.â€
- â€œNational holiday â€” hours may differ. Please check the official site.â€
- â€œClosed today (deferred rest day after holiday).â€

---

## ğŸ§® Pseudocode Summary

```ts
function sightStatus(s, date) {
  if (hasException(s, date)) return CLOSED("Exception");

  const isHol = isHoliday(date);
  const wd = weekday(date);

  if (isHol) {
    if (s.holiday_policy === "closed") return CLOSED("Holiday");
    if (s.holiday_policy === "open") return OPEN("Holiday");
    return UNKNOWN("Holiday â€“ check");
  }

  if (s.closed_days?.includes(wd)) return CLOSED("Recurring");

  const prev = addDays(date, -1);
  if (
    isHoliday(prev) &&
    s.closed_days?.includes(weekday(prev)) &&
    s.defer_closure_on_holiday === "next_weekday" &&
    !isHoliday(date)
  ) {
    return CLOSED("Deferred");
  }

  return OPEN("Normal");
}
```
